var Cell=function(){function t(t,e){this.row=t,this.column=e,this.element=$("<div class='cell notBombed'></div>")[0]}return t.parseCellLocation=function(t){var e=t.split(",");return{row:parseInt(e[0]),column:parseInt(e[1])}},t.prototype.cellLocation=function(){return""+this.row+","+this.column},t}(),Ship=function(){function t(t){this.size=t,this.column=0,this.row=0,this.isVertical=!0,this.hits=0,this.element=$("<div class='ship'></div>")[0]}return t.prototype.updatePosition=function(t,e,i){this.row=t,this.column=e,this.isVertical=i,this.updateLayout()},t.prototype.updateLayout=function(){var t="9.9%",e=""+9.9*this.size+"%";this.element.style.left=""+10*this.column+"%",this.element.style.top=""+10*this.row+"%",this.element.style.width=this.isVertical?t:e,this.element.style.height=this.isVertical?e:t},t.prototype.flipShip=function(){this.isVertical=!this.isVertical,this.isVertical?this.row+this.size>10&&(this.row=10-this.size):this.column+this.size>10&&(this.column=10-this.size),this.updateLayout()},t.prototype.getCellsCovered=function(){for(var t=[],e=this.row,i=this.column,s=0;s<this.size;s++)t.push(e.toString()+","+i.toString()),this.isVertical?e++:i++;return t},t.prototype.isSunk=function(){return this.hits===this.size},t}(),Board=function(){function t(t,e){var i=this;void 0===e&&(e=!0),this.element=t,this.playerTurn=!1,this.shipSizes=[5,4,3,3,2],this.positioningEnabled=e,this.cells=[],this.ships=[];for(var s=null,a=0;10>a;a++){this.cells[a]=[];for(var o=0;10>o;o++)s=new Cell(a,o),this.cells[a][o]=s,t.appendChild(s.element),$(s.element).data("cellLocation",s.cellLocation()),e&&$(s.element).droppable({disabled:!1,drop:function(t,e){var a=e.draggable[0],o=$(a).data("shipIndex"),n=i.ships[o],r=Math.round(a.offsetLeft/s.element.offsetWidth),l=Math.round(a.offsetTop/s.element.offsetHeight);n.updatePosition(l,r,n.isVertical)}})}for(var n=$(s.element),r=0;r<this.shipSizes.length;r++){var l=new Ship(this.shipSizes[r]);this.ships[r]=l,l.updatePosition(r,0,!1),e&&(this.element.appendChild(l.element),l.updateLayout(),$(l.element).data("shipIndex",r).draggable({disabled:!1,containment:"parent",grid:[.99*n.width()+2,.99*n.height()+2],cursor:"crosshair"}).click(function(t){if(i.positioningEnabled){var e=$(t.target).data("shipIndex");i.ships[e].flipShip()}}))}$(window).resize(function(t){$(i.element).children(".ship").draggable("option","grid",[.99*n.width()+2,.99*n.height()+2])}),e||$(t).click(function(t){return i.onCellClick(t)})}return Object.defineProperty(t.prototype,"dragAndDropEnabled",{set:function(t){var e=$(this.element).children(".cell"),i=$(this.element).children(".ship");this.positioningEnabled=t,i.draggable("option","disabled",!t),e.droppable("option","disabled",!t)},enumerable:!0,configurable:!0}),t.getRandomPosition=function(){return{row:Math.floor(10*Math.random()),column:Math.floor(10*Math.random()),vertical:1===Math.floor(2*Math.random())}},t.prototype.onCellClick=function(t){var e=t.target;$(e).hasClass("cell")!==!1&&(this.playerTurn||this.onEvent.call(this,"click"),this.playerTurn&&this.bombCell(e))},t.prototype.bombCell=function(t){var e=Cell.parseCellLocation($(t).data("cellLocation")),i=this.cells[e.row][e.column];if(!i.hasHit)if(i.hasHit=!0,i.shipIndex>=0){$(t).removeClass("notBombed"),$(t).addClass("cellHit");var s=this.ships[i.shipIndex];s.hits++,s.isSunk()?this.allShipsSunk()?this.onEvent.call(this,"allSunk"):this.onEvent.call(this,"shipSunk"):this.onEvent.call(this,"hit")}else $(t).removeClass("notBombed"),$(t).addClass("cellMiss"),this.onEvent.call(this,"playerMissed")},t.prototype.randomize=function(){var e=this.ships.length;do for(var i=0;e>i;i++){var s=t.getRandomPosition();this.ships[i].updatePosition(s.row,s.column,s.vertical)}while(!this.boardIsValid())},t.prototype.boardIsValid=function(){for(var t=[],e=0;e<this.ships.length;e++)t=t.concat(this.ships[e].getCellsCovered());t.sort();var i=t.some(function(t,e,i){return t===i[e+1]}),s=t.some(function(t){var e=Cell.parseCellLocation(t);return!(e.column>=0&&e.column<=9&&e.row>=0&&e.row<=9)});return i||s?!1:(this.updateCellData(),!0)},t.prototype.chooseMove=function(){do var e=t.getRandomPosition(),i=this.cells[e.row][e.column];while(i.hasHit);this.bombCell(i.element)},t.prototype.updateCellData=function(){for(var t=0;100>t;t++){var e=this.cells[Math.floor(t/10)][t%10];e.hasHit=!1,e.shipIndex=-1}for(var i=0;i<this.ships.length;i++){var s=this.ships[i];s.hits=0;for(var a=s.getCellsCovered(),o=0;o<a.length;o++){var n=Cell.parseCellLocation(a[o]),r=this.cells[n.row][n.column];r.shipIndex=i}}$(this.element).children(".cell").removeClass("cellHit cellMiss").addClass("notBombed")},t.prototype.allShipsSunk=function(){return this.ships.every(function(t){return t.isSunk()})},t}(),Game=function(){function t(){var e=this;this.state=t.gameState.begin,this.updateStatus(t.msgs.gameStart),this.playerBoard=new Board($("#playerBoard")[0]),this.computerBoard=new Board($("#computerBoard")[0],!1),this.computerBoard.randomize(),this.playerBoard.randomize(),this.playerBoard.dragAndDropEnabled=!0,this.computerBoard.onEvent=function(i){switch(i){case"click":switch(e.state){case t.gameState.begin:e.startGame();break;case t.gameState.computerTurn:e.updateStatus(t.msgs.wait);break;case t.gameState.finished:e.computerBoard.randomize(),e.playerBoard.randomize(),e.playerBoard.dragAndDropEnabled=!0,e.updateStatus(t.msgs.gameStart),e.state=t.gameState.begin}break;case"playerMissed":e.computersTurn();break;case"hit":e.updateStatus(t.msgs.hit),e.computersTurn();break;case"shipSunk":e.updateStatus(t.msgs.shipSunk),e.computersTurn();break;case"allSunk":e.state=t.gameState.finished,e.computerBoard.playerTurn=!1,e.updateStatus(t.msgs.allSunk)}},this.playerBoard.onEvent=function(i){switch(i){case"playerMissed":case"hit":e.computerBoard.playerTurn=!0;break;case"shipSunk":e.updateStatus(t.msgs.lostShip),e.computerBoard.playerTurn=!0;break;case"allSunk":e.updateStatus(t.msgs.lostGame),e.computerBoard.playerTurn=!1,e.state=t.gameState.finished}}}return t.prototype.computersTurn=function(){var e=this;this.computerBoard.playerTurn=!1,this.state=t.gameState.computerTurn,setTimeout(function(){e.playerBoard.chooseMove()},250)},t.prototype.startGame=function(){this.playerBoard.boardIsValid()?(this.state=t.gameState.playerTurn,this.playerBoard.dragAndDropEnabled=!1,this.computerBoard.playerTurn=!0,this.updateStatus(t.msgs.gameOn)):this.updateStatus(t.msgs.invalidPositions)},t.prototype.updateStatus=function(t){$("#status").slideUp("fast",function(){$(this).text(t).slideDown("fast")})},t.gameState={begin:0,computerTurn:1,playerTurn:2,finished:3},t.msgs={gameStart:"Drag your ships to the desired location on your board (on the right), then bomb a square on the left board to start the game!",invalidPositions:"All ships must be in valid positions before the game can begin.",wait:"Wait your turn!",gameOn:"Game on!",hit:"Good hit!",shipSunk:"You sunk a ship!",lostShip:"You lost a ship :-(",lostGame:"You lost this time. Click anywhere on the left board to play again.",allSunk:"Congratulations!  You won!  Click anywhere on the left board to play again."},t}();$(new Function("var game = new Game();"));